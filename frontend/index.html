<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="UTF-8">
    <meta name="viewport">
    <title>Resource Creation</title>
    <link href="/node_modules/bootstrap/dist/css/bootstrap.css" rel="stylesheet">
    <script src="/node_modules/bootstrap/dist/js/bootstrap.bundle.js"></script>
</head>
<body>
<div class="form-1-container section-container">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-sm text-center">
                <div class="header">
                    <h1>Resource management</h1>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="d-grid col-6">
                <button type="button" id="createControl" data-bs-toggle="collapse"
                        data-bs-target="#instanceCreationForm"
                        aria-expanded="false"
                        class="btn btn-primary btn-customized btn-lg">
                    Create a new instance
                </button>
            </div>
            <div class="d-grid col-6">
                <button type="button" id="listControl" data-bs-toggle="collapse"
                        data-bs-target="#instanceListTable"
                        aria-expanded="false"
                        class="btn btn-primary btn-customized btn-lg">
                    Show currently available instances
                </button>
            </div>
        </div>
        <div class="row collapse" id="instanceCreationForm" aria-expanded="false">
            <div class="col-md-12">
                <form action="" id="creationForm" method="post">
                    <div class="row justify-content-center">
                        <div class="col-md-10 form-1-box section-description wow fadeIn">
                            <h2>VM options</h2>
                            <div class="divider-1 wow fadeInUp"><span></span></div>
                            <p>Select options for a new virtual machine</p>
                        </div>
                    </div>
                    <div class="row justify-content-center">
                        <div class="col-md-10 form-1-box wow fadeInUp">
                            <!-- VM type  -->
                            <fieldset class="form-group border p-3">
                                <legend class="w-auto px-2">VM type</legend>
                                <div class="form-group">
                                    <input class="form-check-input" type="radio" id="cpu" name="type" value="cpu"
                                           checked/>
                                    <label class="form-check-label" for="cpu">CPU</label>
                                </div>

                                <div class="form-group">
                                    <input class="form-check-input" type="radio" id="gpu" name="type" value="gpu"/>
                                    <label class="form-check-label" for="gpu">GPU</label>
                                </div>
                            </fieldset>
                            <!-- VM Size  -->
                            <fieldset class="form-group border p-3">
                                <legend class="w-auto px-2">VM Size</legend>
                                <div class="form-group">
                                    <input class="form-check-input" type="radio" id="small" name="size" value="small"/>
                                    <label class="form-check-label" for="small">Small</label>
                                </div>

                                <div class="form-group">
                                    <input class="form-check-input" type="radio" id="medium" name="size" value="medium"
                                           checked/>
                                    <label class="form-check-label" for="medium">Medium</label>
                                </div>

                                <div class="form-group">
                                    <input class="form-check-input" type="radio" id="large" name="size" value="large"/>
                                    <label class="form-check-label" for="large">Large</label>
                                </div>
                            </fieldset>
                            <!-- Python Environments  -->
                            <fieldset class="form-group border p-3">
                                <legend class="w-auto px-2">Python environments</legend>
                                <div class="form-group">
                                    <input class="form-check-input" type="checkbox" id="neuralactivitycubic"
                                           name="python"
                                           value="neuralactivitycubic"/>
                                    <label class="form-check-label"
                                           for="neuralactivitycubic">NeuralActivityCubic</label>
                                </div>

                                <div class="form-group">
                                    <input class="form-check-input" type="checkbox" id="nbdev" name="python"
                                           value="nbdev"/>
                                    <label class="form-check-label" for="nbdev">nbdev</label>
                                </div>

                                <div class="form-group">
                                    <input class="form-check-input" type="checkbox" id="sklearn" name="python"
                                           value="sklearn"/>
                                    <label class="form-check-label" for="sklearn">scikit-learn</label>
                                </div>

                            </fieldset>
                            <!-- Custom Repo -->
                            <fieldset class="form-group border p-3">
                                <legend class="w-auto px-2">Additional Package</legend>
                                <div class="row">
                                    <div class="col input-group">
                                        <input class="form-control" type="url" id="customRepo" name="customRepo"
                                               value="" placeholder="https://github.com/"/>
                                        <label for="customRepo"></label>
                                        <button class="btn btn-primary" type="button" id="check">Check</button>
                                    </div>
                                    <div class="form-text" id="basic-addon4">
                                            A custom repository url with Python package
                                    </div>
                                </div>
                            </fieldset>
                            <!-- Submit Button -->
                            <div class="form-group row text-center mb-5">
                                <div class="d-grid gap-2">
                                    <button type="button" id="launch" class="btn btn-primary btn-customized btn-lg">
                                        Launch
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        <div class="row justify-content-center collapse mb-5" id="instanceListTable">
            <div class="row justify-content-center">
                <div class="col-md-10 form-1-box section-description wow fadeIn">
                    <h2>All currently available instances</h2>
                </div>
            </div>
            <!-- HEADER -->
            <div class="row justify-content-center text-center">
                <div class="col-md-10 section-description bg-secondary-subtle h4">
                    <div class="row justify-content-center text-center">
                        <div class="col-4 border">
                            IP Address
                        </div>
                        <div class="col-4 border">
                            Name
                        </div>
                        <div class="col-4 border">
                            Actions
                        </div>
                    </div>
                </div>
            </div>
            <!-- BODY -->
            <div class="row justify-content-center text-center">
                <div class="col-md-10" id="instancesTable">
                    <!-- here be dragons -->
                </div>
            </div>
        </div>
    </div>
</div>

<div id="display" class="d-none">these are all selected options</div>
</body>
</html>
<!-- JS  SECTION -->
<script type="module">
    const createColumn = (content, size = 4) => {
        let col = document.createElement('div');
        col.classList.add(`col-${size}`, 'border');
        content instanceof Element ? col.appendChild(content) : col.innerText = content;
        return col
    }

    const makeLink = (url) => {
        let a = document.createElement('a');
        a.href = 'http://' + url;
        a.textContent = url;
        return a
    }

    const createInstanceRow = (instance) => {
        let row = document.createElement('div');
        row.classList.add('row', 'justify-content-center', 'text-center');
        row.appendChild(createColumn(makeLink(`${instance.public_ip}:8080`)));
        row.appendChild(createColumn(instance.name));
        row.appendChild(createColumn('WIP: button DELETE'));
        return row
    }

    const appendInstanceRows = (rows) => {
        let table = document.getElementById('instancesTable');
        table.replaceChildren(...rows);
    }

    const listInstances = () => {
        let url = 'http://127.0.0.1:9991/path-hash/vms/';  // Replace with your URL

        fetch(url, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'Access-Control-Allow-Origin': '*',
            },
        })
            .then(response => response.json())  // Parses the JSON response
            .then(data => {
                let instanceRows = data.map(instance => createInstanceRow(instance));
                appendInstanceRows(instanceRows);
            })
            .catch(error => console.error('Error:', error));
    };

    const collectFormData = () => {
        let form = document.getElementById('creationForm');
        return new FormData(form);
    };

    const createInstance = () => {
        let formData = collectFormData();

        let url = 'http://127.0.0.1:9991/path-hash/vms/';  // Replace with your URL

        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Access-Control-Allow-Origin': '*',
            },
            body: JSON.stringify({
            python_envs: formData.getAll('python'),
            size: formData.get('size')
        })
        })
            .then(response => response.json())  // Parses the JSON response
            .then(data => {listInstances();})
            .catch(error => console.error('Error:', error));
    };

    const checkCustomRepo = () => {
        let formData = collectFormData();

        let url = 'http://127.0.0.1:9991/path-hash/repos/validate/' + formData.get('customRepo');

        fetch(url, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'Access-Control-Allow-Origin': '*',
            },
        })
            .then(response => response.json())  // Parses the JSON response
            .then(data => console.log(data))
            .catch(error => console.error('Error:', error));
    }

    const controlCollapse = () => {
        let instanceListTable = document.getElementById('instanceListTable');
        let instanceCreationForm = document.getElementById('instanceCreationForm');

        let instanceListTableCollapse = new bootstrap.Collapse(instanceListTable, {toggle: false});
        let instanceCreationFormCollapse = new bootstrap.Collapse(instanceCreationForm, {toggle: false});

        instanceListTable.addEventListener('show.bs.collapse', event => instanceCreationFormCollapse.hide());
        instanceCreationForm.addEventListener('show.bs.collapse', event => instanceListTableCollapse.hide());
    }


    document.getElementById('instanceListTable').addEventListener('shown.bs.collapse', listInstances);
    document.getElementById('launch').addEventListener('click', createInstance);
    document.getElementById('check').addEventListener('click', checkCustomRepo);
    controlCollapse();

</script>
<!-- STYLE  SECTION -->

<style>
    .result {
        padding-top: 30px;
    }

    .header {
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .form-1-box {
        padding-top: 30px;
        text-align: left;
    }

    .form-1-box legend {
        font-size: inherit;
        line-height: 30px;
        font-weight: 600;
        text-transform: uppercase;
        color: #555;
    }

    .form-1-box .form-check-label {
        line-height: 1.5;
        vertical-align: top;
    }

    .form-1-box input[type="text"],
    .form-1-box input[type="email"],
    .form-1-box input[type="password"] {
        background: none;
        border: 1px solid #ddd;
        font-family: 'Open Sans', sans-serif;
        font-size: 15px;
        font-weight: 400;
        color: #888;
        box-shadow: none;
    }

    .form-1-box input[type="text"]:focus,
    .form-1-box input[type="email"]:focus,
    .form-1-box input[type="password"]:focus {
        outline: 0;
        background: none;
        border: 1px solid #db5d50;
        box-shadow: none;
    }

    .form-1-box input[type="text"]::-moz-placeholder,
    .form-1-box input[type="email"]::-moz-placeholder,
    .form-1-box input[type="password"]::-moz-placeholder {
        color: #bbb;
        font-style: italic;
    }

    .form-1-box input[type="text"]:-ms-input-placeholder,
    .form-1-box input[type="email"]:-ms-input-placeholder,
    .form-1-box input[type="password"]:-ms-input-placeholder {
        color: #bbb;
        font-style: italic;
    }

    .form-1-box input[type="text"]::-webkit-input-placeholder,
    .form-1-box input[type="email"]::-webkit-input-placeholder,
    .form-1-box input[type="password"]::-webkit-input-placeholder {
        color: #bbb;
        font-style: italic;
    }

    .form-1-box button.btn-customized {
        margin-top: 1rem;
        padding: .75rem 1.5rem;
        background: #db5d50;
        border: 0;
        font-family: 'Open Sans', sans-serif;
        font-size: 15px;
        font-weight: 400;
        color: #fff;
        box-shadow: none;
    }

    .form-1-box button.btn-customized:hover,
    .form-1-box button.btn-customized:active,
    .form-1-box button.btn-customized:focus,
    .form-1-box button.btn-customized:active:focus,
    .form-1-box button.btn-customized.active:focus,
    .form-1-box button.btn.btn-primary:not(:disabled):not(.disabled):active,
    .form-1-box button.btn.btn-primary:not(:disabled):not(.disabled):active:focus {
        outline: 0;
        background: #ca594d;
        border: 0;
        color: #fff;
        box-shadow: none;
    }
</style>

<!-- CHIMICHANGA -->
